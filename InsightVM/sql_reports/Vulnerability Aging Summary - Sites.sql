WITH
   vuln_result_categorization AS (
      SELECT asset_id,
         CASE WHEN (age_in_days <= 30 AND severity_score < 4) THEN 1 ELSE 0 END AS "<30m",
         CASE WHEN (age_in_days <= 30 AND severity_score >= 4 AND severity_score < 7) THEN 1 ELSE 0 END AS "<30s",
         CASE WHEN (age_in_days <= 30 AND severity_score >= 7) THEN 1 ELSE 0 END AS "<30c",
         CASE WHEN (age_in_days <= 60 AND age_in_days >= 31 AND severity_score < 4) THEN 1 ELSE 0 END AS "31-60m",
         CASE WHEN (age_in_days <= 60 AND age_in_days >= 31 AND severity_score >= 4 AND severity_score < 7) THEN 1 ELSE 0 END AS "31-60s",
         CASE WHEN (age_in_days <= 60 AND age_in_days >= 31 AND severity_score >= 7) THEN 1 ELSE 0 END AS "31-60c",
         CASE WHEN (age_in_days <= 90 AND age_in_days >= 61 AND severity_score < 4) THEN 1 ELSE 0 END AS "61-90m",
         CASE WHEN (age_in_days <= 90 AND age_in_days >= 61 AND severity_score >= 4 AND severity_score < 7) THEN 1 ELSE 0 END AS "61-90s",
         CASE WHEN (age_in_days <= 90 AND age_in_days >= 61 AND severity_score >= 7) THEN 1 ELSE 0 END AS "61-90c",
         CASE WHEN (age_in_days > 90 AND severity_score < 4) THEN 1 ELSE 0 END AS "91+m",
         CASE WHEN (age_in_days > 90 AND severity_score >= 4 AND severity_score < 7) THEN 1 ELSE 0 END AS "91+s",
         CASE WHEN (age_in_days > 90 AND severity_score >= 7) THEN 1 ELSE 0 END AS "91+c"
      FROM (
         SELECT fav.asset_id, fav.vulnerability_id, fava.age_in_days, dv.severity_score
         FROM fact_asset_vulnerability_finding fav
            JOIN dim_vulnerability dv ON fav.vulnerability_id = dv.vulnerability_id
            JOIN fact_asset_vulnerability_age fava ON fava.asset_id = fav.asset_id AND fava.vulnerability_id = fav.vulnerability_id
         GROUP BY fav.asset_id, fav.vulnerability_id, dv.date_published, dv.severity_score, fava.age_in_days
      ) avd
   )
SELECT ds.name AS site,
   fs.assets AS asset_count,
   fs.vulnerabilities AS vulnerabilities,
   SUM("<30m") AS "<30_moderate",
   SUM("31-60m") AS "31-60_moderate",
   SUM("61-90m") AS "61-90_moderate",
   SUM("91+m") AS "91+_moderate",
   SUM("<30s") AS "<30_severe",
   SUM("31-60s") AS "31-60_severe",
   SUM("61-90s") AS "61-90_severe",
   SUM("91+s") AS "91+_severe",
   SUM("<30c") AS ">30_critical",
   SUM("31-60c") AS "31-60_critical",
   SUM("61-90c") AS "61-90_critical",
   SUM("91+c") AS "91+_critical"
FROM (
   SELECT da.asset_id, 0 AS "<30m", 0 AS "<30s", 0 AS "<30c", 0 AS "31-60m", 0 AS "31-60s", 0 AS "31-60c", 0 AS "61-90m", 0 AS "61-90s", 0 AS "61-90c", 0 AS "91+m", 0 AS "91+s", 0 AS "91+c"
   FROM dim_asset da
   WHERE da.asset_id IN (SELECT asset_id FROM vuln_result_categorization)
   UNION ALL
   SELECT *
   FROM vuln_result_categorization
) v
JOIN dim_site_asset dsa ON dsa.asset_id = v.asset_id
JOIN dim_site ds ON ds.site_id = dsa.site_id
JOIN fact_site fs ON fs.site_id = ds.site_id
WHERE ds.site_id IN (SELECT site_id FROM dim_scope_site)
GROUP BY ds.name, fs.assets, fs.vulnerabilities;

